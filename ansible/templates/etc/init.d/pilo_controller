#!/bin/sh
### BEGIN INIT INFO
# Provides:          pilo_controller
# Required-Start:    $local_fs $remote_fs $network $syslog exim4 
# Required-Stop:     $local_fs $remote_fs $network $syslog exim4
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: PILO Client Service
# Description:       Start and stop PILO Client 
### END INIT INFO

# Do NOT "set -e"
set -x

ETH=eth0
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DESC="Pilo Controller startup"
NAME=pilo_controller
SCRIPTNAME=/etc/init.d/$NAME
DAEMON_USER=root
DAEMON_GROUP=root
PIDFILE=/var/run/$NAME.pid
LOGFILE=/var/log/$NAME.log

# Read configuration variable file if it is present
[ -r /etc/default/$NAME.conf ] && . /etc/default/$NAME.conf

# Load the VERBOSE setting and other rcS variables
. /lib/init/vars.sh

# Define LSB log_* functions.
# Depend on lsb-base (>= 3.2-14) to ensure that this file is present
# and status_of_proc is working.
. /lib/lsb/init-functions

#
# Function that starts the service
#
do_start()
{
	# Return
	#   0 if daemon has been started
	#   1 if daemon was already running
	#   2 if daemon could not be started

  # TODO: Check to see if daemon is already running
  read PID <$PIDFILE
  if  kill -0 ${PID} 
  then
    return 1
  fi

  ovs-vsctl add-br br-int
  for interface in $OVS_INTERFACES
  do
    echo "$interface"
    ovs-vsctl add-port br-int $interface
    ip addr flush dev $interface
  done

  ip addr add $BR_ADDR dev br-int
  ovs-vsctl set bridge br-int other-config:hwaddr=$BR_MAC
  ovs-vsctl set-controller br-int tcp:127.0.0.1:6633

  cd /vagrant/shared/pox 
  ./pox.py log --file=$LOGFILE log.level --DEBUG --no-default proto.arp_responder --eat_packets=False --$BR_IP=$BR_MAC misc.pilo_controller --retransmission_timeout=$RETRANSMISSION_TIMEOUT --udp_ip=$UDP_IP --udp_port=$UDP_PORT --this_if="br-int" --client_macs=$CLIENT_MACS & 
  echo "$!" > $PIDFILE
	
  return 0
}

#
# Function that stops the daemon/service
#
do_stop()
{
	# Return
	#   0 if daemon has been stopped
	#   1 if daemon was already stopped
	#   2 if daemon could not be stopped

  read PID <$PIDFILE
  while kill -0 ${PID}; do
    kill -9 $PID
    echo "Killing pilo_controller"
    sleep 1
  done

  for interface in $OVS_INTERFACES
  do
    echo "$interface"
    ovs-vsctl del-port br-int $interface
    ifdown $interface
    ifup $interface
  done
  ip addr del $BR_ADDR dev br-int
  ovs-vsctl del-br br-int
	
	return 0
}

case "$1" in
	start)
		[ "$VERBOSE" != no ] && log_daemon_msg "Starting $DESC" "$NAME"
		do_start
		case "$?" in
			0|1) [ "$VERBOSE" != no ] && log_end_msg 0 ;;
			*) [ "$VERBOSE" != no ] && log_end_msg 1 ;;
		esac
		;;
	stop)
		[ "$VERBOSE" != no ] && log_daemon_msg "Stopping $DESC" "$NAME"
		do_stop
		case "$?" in
			0|1) [ "$VERBOSE" != no ] && log_end_msg 0 ;;
			*) [ "$VERBOSE" != no ] && log_end_msg 1 ;;
		esac
		;;
	*)
		echo "Usage: $SCRIPTNAME {start|stop|restart|status}" >&2
		exit 3
		;;
esac

:
